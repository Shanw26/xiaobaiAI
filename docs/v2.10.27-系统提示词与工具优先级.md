# 系统提示词与工具优先级 (v2.10.27)

> **适用版本**: v2.10.27+
> **功能类型**: 系统提示词优化
> **更新时间**: 2026-01-09
> **相关问题**: 确保 AI 优先使用专用工具而非 shell 命令

---

## 📋 概述

小白AI v2.10.27 对系统提示词进行了重大优化，明确要求 AI **优先使用专用工具**而不是执行 shell 命令。这一改进确保了：

- ✅ **跨平台兼容性**：工具自动适配不同操作系统
- ✅ **操作安全性**：避免误执行危险的 shell 命令
- ✅ **结果准确性**：工具提供结构化的返回结果
- ✅ **用户体验**：操作可逆、可追踪

---

## 🎯 核心问题

### v2.10.26 之前的问题

**现象**：用户说"清空回收站"，AI 执行了错误的命令：

```bash
# AI 生成的命令（错误）
rm -rf ~/.local/share/Trash/files/* ~/.local/share/Trash/info/*
```

**问题**：
1. ❌ 这是 Linux 的回收站路径，不适用于 macOS
2. ❌ macOS 的回收站路径是 `~/.Trash/`
3. ❌ AI 没有使用专用的 `empty_trash` 工具
4. ❌ 用户看到"命令执行成功"，但回收站实际上没被清空

---

## ✨ v2.10.27 解决方案

### 1. 新增专用工具

在 `electron/agent.js` 中添加了 `empty_trash` 工具：

```javascript
{
  name: 'empty_trash',
  description: '清空回收站（删除所有已删除的文件）。⚠️ 注意：此操作不可逆，请谨慎使用！...',
  input_schema: {
    type: 'object',
    properties: {},
  },
}
```

**跨平台支持**：
```javascript
async function emptyTrash() {
  const platform = process.platform;

  if (platform === 'darwin') {
    // macOS: 使用 AppleScript
    const script = 'tell application "Finder" to empty trash';
    await execPromise(`osascript -e '${script}'`);
  } else if (platform === 'win32') {
    // Windows: 使用 PowerShell
    const script = `
      $shell = New-Object -ComObject Shell.Application
      $shell.Namespace(0xA).Items() | ForEach-Object {
        Remove-Item $_.Path -Recurse -Force
      }
    `;
    await execPromise(`powershell -NoProfile -Command "${script}"`);
  } else {
    // Linux: 清空 ~/.local/share/Trash/
    await execPromise('rm -rf ~/.local/share/Trash/*');
  }
}
```

### 2. 优化系统提示词

**位置**: `electron/agent.js` 第 937-1007 行

**新增章节**: `🛠️ 工具使用规则（重要）`

```markdown
## 🛠️ 工具使用规则（重要）

你必须优先使用专用工具，而不是执行 shell 命令：

### 1. 文件系统操作
- **清空回收站** → 调用 `empty_trash` 工具（不要用 rm 命令）
- **删除文件** → 调用 `delete_file` 工具
- **移到回收站** → 调用 `move_to_trash_file` 工具
- **创建目录** → 调用 `create_directory` 工具
- **列出目录** → 调用 `list_directory` 工具
- **读取文件** → 调用 `read_file` 工具
- **写入文件** → 调用 `write_file` 工具

### 2. 何时使用 execute_command
只有在以下情况才使用 `execute_command` 工具：
- 查看系统信息（如：ps aux, top, df -h）
- 查看进程列表
- 查看网络状态
- 执行 git 命令
- 其他无法用专用工具完成的操作

### 3. 常见错误示例
❌ 用户说"清空回收站"，你执行：rm -rf ~/.Trash/*
✅ 用户说"清空回收站"，你调用：empty_trash 工具

❌ 用户说"删除这个文件"，你执行：rm /path/to/file
✅ 用户说"删除这个文件"，你调用：delete_file 工具
```

---

## 📊 工具优先级对照表

### 文件系统操作

| 用户需求 | ✅ 正确做法 | ❌ 错误做法 |
|---------|-----------|-----------|
| 清空回收站 | 调用 `empty_trash` | `rm -rf ~/.Trash/*` |
| 删除文件 | 调用 `delete_file` | `rm /path/to/file` |
| 移到回收站 | 调用 `move_to_trash_file` | 手动移动 |
| 创建目录 | 调用 `create_directory` | `mkdir /path/to/dir` |
| 列出目录 | 调用 `list_directory` | `ls -la` |
| 读取文件 | 调用 `read_file` | `cat /path/to/file` |
| 写入文件 | 调用 `write_file` | `echo "content" > file` |

### 系统信息查询

| 用户需求 | ✅ 正确做法 | 工具类型 |
|---------|-----------|---------|
| 查看进程 | `execute_command` + `ps aux` | 系统命令 |
| 查看磁盘 | `execute_command` + `df -h` | 系统命令 |
| 查看内存 | `execute_command` + `top` | 系统命令 |
| git 操作 | `execute_command` + `git status` | 系统命令 |
| 网络状态 | `execute_command` + `netstat` | 系统命令 |

---

## 🔍 工作原理

### AI 决策流程

```
用户请求
  ↓
AI 分析需求
  ↓
判断：是否有专用工具？
  ├─ 有 → 使用专用工具 ✅
  └─ 没有 → 使用 execute_command
```

### 示例对话

**场景 1：清空回收站**

```
用户: 请清空回收站

AI 分析:
- 需求：清空回收站
- 检查：是否有专用工具？
- 结果：有 → empty_trash

AI 执行:
⏺ 分析问题
  用户请求清空回收站

⏺ 执行方案
  调用：empty_trash 工具

⏺ 完成！
  ✅ 回收站已清空
```

**场景 2：查看进程**

```
用户: 帮我查看一下进程列表

AI 分析:
- 需求：查看进程列表
- 检查：是否有专用工具？
- 结果：没有 → 使用 execute_command

AI 执行:
⏺ 分析问题
  用户需要查看系统进程

⏺ 执行方案
  调用：execute_command 工具
  命令：ps aux

⏺ 完成！
  [显示进程列表]
```

---

## 🛠️ 可用工具列表

### 文件操作工具

| 工具名称 | 功能描述 | 输入参数 |
|---------|---------|---------|
| `write_file` | 写入文件 | filePath, content |
| `read_file` | 读取文件 | filePath |
| `list_directory` | 列出目录 | dirPath |
| `create_directory` | 创建目录 | dirPath |
| `delete_file` | 删除文件 | filePath |
| `move_to_trash_file` | 移到回收站 | filePath |
| `empty_trash` | 清空回收站 | 无 |
| `execute_command` | 执行命令 | command, options |

### 工具调用示例

#### 1. 清空回收站
```javascript
{
  "tool_use": {
    "name": "empty_trash",
    "input": {}
  }
}
```

#### 2. 删除文件
```javascript
{
  "tool_use": {
    "name": "delete_file",
    "input": {
      "filePath": "/Users/xxx/Desktop/test.txt"
    }
  }
}
```

#### 3. 创建目录
```javascript
{
  "tool_use": {
    "name": "create_directory",
    "input": {
      "dirPath": "~/Desktop/new-folder"
    }
  }
}
```

#### 4. 执行命令
```javascript
{
  "tool_use": {
    "name": "execute_command",
    "input": {
      "command": "ps aux | grep node"
    }
  }
}
```

---

## 📝 完整的系统提示词

**位置**: `electron/agent.js` 第 937-1007 行

```javascript
const systemPrompt = `你是小白AI，一个基于 Claude Agent SDK 的 AI 助手。

## 📝 用户记忆

${aiMemory}

---

## 🛠️ 工具使用规则（重要）

你必须优先使用专用工具，而不是执行 shell 命令：

### 1. 文件系统操作
- **清空回收站** → 调用 \`empty_trash\` 工具（不要用 rm 命令）
- **删除文件** → 调用 \`delete_file\` 工具
- **移到回收站** → 调用 \`move_to_trash_file\` 工具
- **创建目录** → 调用 \`create_directory\` 工具
- **列出目录** → 调用 \`list_directory\` 工具
- **读取文件** → 调用 \`read_file\` 工具
- **写入文件** → 调用 \`write_file\` 工具

### 2. 何时使用 execute_command
只有在以下情况才使用 \`execute_command\` 工具：
- 查看系统信息（如：ps aux, top, df -h）
- 查看进程列表
- 查看网络状态
- 执行 git 命令
- 其他无法用专用工具完成的操作

### 3. 常见错误示例
❌ 用户说"清空回收站"，你执行：rm -rf ~/.Trash/*
✅ 用户说"清空回收站"，你调用：empty_trash 工具

❌ 用户说"删除这个文件"，你执行：rm /path/to/file
✅ 用户说"删除这个文件"，你调用：delete_file 工具

---

## 工作原则

1. **诚实优先**：不知道就说不知道，不编造信息
2. **工具优先**：所有操作优先使用专用工具，确保结果准确
3. **简洁沟通**：直接回答，不绕弯子
4. **文件路径格式**：必须用反引号包裹路径（如 \`/path/to/file\`），方便用户点击

## 思考过程展示（涉及工具调用时）

格式要求：
⏺ 分析问题
  内容（1-2句）

⏺ 执行方案
  调用：xxx 工具

⏺ 完成！
  结果

何时展示：工具调用任务、技术问题、代码修改（纯聊天可省略）

## 命令执行规则

直接执行：打开应用、查看信息、查找文件
询问确认：删除文件、系统配置修改、sudo 操作

## 用户信息保存

直接保存：用户说"帮我保存"、"直接记下来"
先询问：用户只提到信息但无明确指令

由晓力开发，帮助用户高效工作。`;
```

---

## 🧪 测试验证

### 测试用例

#### 测试 1：清空回收站
```
用户输入: "请清空回收站"

预期行为:
- AI 调用 empty_trash 工具
- 不执行 rm 命令
- 返回: "✅ 回收站已清空"

实际日志:
✅ macOS 回收站已清空
```

#### 测试 2：删除文件
```
用户输入: "删除桌面上的test.txt"

预期行为:
- AI 调用 delete_file 工具
- 不执行 rm 命令
- 返回: "✅ 文件已删除：`~/Desktop/test.txt`"
```

#### 测试 3：查看进程
```
用户输入: "帮我查看一下进程列表"

预期行为:
- AI 调用 execute_command 工具
- 执行: ps aux
- 返回进程列表
```

### 验证方法

1. **查看日志**：检查 AI 是否调用了正确的工具
   ```bash
   tail -f /tmp/claude/-Users-shawn-Downloads------Claude-code/tasks/bxxxxxx.output
   ```

2. **工具调用标识**：
   ```
   Agent: 调用工具 empty_trash { }
   ```

3. **错误示例检测**：
   - 如果看到 `rm -rf ~/.Trash/*` → ❌ 未生效
   - 如果看到 `Agent: 调用工具 empty_trash` → ✅ 已生效

---

## 🚀 未来改进方向

### 短期（v2.10.28+）

- [ ] 添加更多专用工具（如：压缩/解压、文件搜索）
- [ ] 优化工具描述，提高 AI 理解准确度
- [ ] 添加工具使用统计和日志

### 中期（v2.11.0+）

- [ ] 支持批量操作工具
- [ ] 添加工具组合功能（如：备份 = 复制 + 压缩）
- [ ] 实现工具执行结果缓存

### 长期

- [ ] AI 自动学习最佳工具选择
- [ ] 基于用户反馈优化提示词
- [ ] 支持自定义工具插件

---

## 📚 相关文档

- [AI 回复规则](./12-ai-reply-rules.md) - AI 行为准则和格式规范
- [思考过程展示](./06-thinking-process.md) - AI 思考过程的格式要求
- [文件路径点击](./05-file-path-click.md) - 路径识别和交互功能
- [更新日志](./10-changelog.md) - 版本历史记录

---

## 🔧 修改文件清单

**v2.10.27 修改的文件**:

1. **electron/agent.js**
   - 新增 `emptyTrash()` 函数（第 95-119 行）
   - 新增 `empty_trash` 工具定义（第 215-222 行）
   - 新增工具处理逻辑（第 427-435 行）
   - 优化系统提示词（第 937-1007 行）

2. **package.json**
   - 版本号更新：2.10.26 → 2.10.27

3. **electron/main.js**
   - APP_VERSION 更新：2.10.26 → 2.10.27

4. **src/components/Sidebar.jsx**
   - 版本号更新：v2.10.26 → v2.10.27

5. **src/components/SettingsModal.jsx**
   - 版本号更新：v2.10.26 → v2.10.27

---

**功能作者**: Claude Code + 晓力
**最后更新**: 2026-01-09
**版本**: v2.10.27
