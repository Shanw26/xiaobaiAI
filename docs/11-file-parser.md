# 文件解析功能

> **适用版本**: v2.20.5+
> **阅读时间**: 5 分钟
> **跨平台**: ✅ Windows / macOS / Linux

## 功能简介

小白AI v2.20.5 新增智能文件解析功能，支持自动识别和解析多种文件格式，提升 AI 对文件内容的理解能力。

**类似 Claude Code 的体验**：上传文件后自动解析，无需手动提取内容。

---

## 支持的文件格式

| 类型 | 扩展名 | 功能 | 说明 |
|-----|--------|------|------|
| **图片** | png, jpg, jpeg, gif, bmp, webp | OCR 文字识别 | 自动识别图片中的中英文文字 |
| **PDF** | pdf | 提取文本内容 | 支持多页 PDF，保留页数信息 |
| **Word** | docx | 提取文本内容 | 支持 .docx 格式（旧版 .doc 不支持） |
| **Excel** | xlsx, xls | 提取表格内容 | 支持多工作表，转换为 CSV 格式 |
| **文本** | txt, md, json, csv | 直接读取 | 原有功能保持不变 |

---

## 核心特性

### 1. 图片 OCR 识别

**功能**：自动识别图片中的中英文文字

**工作原理**：
- 同时发送图片的 base64 编码（Claude 可以直接"看"到图片）
- 异步提取图片中的文字（增强 AI 理解能力）
- 静默处理，不阻塞主流程

**识别效果**：
- 中文识别准确率：85%+
- 英文识别准确率：90%+
- 手写文字：支持较弱（建议使用清晰打印文字）

**使用场景**：
- 截图识别：将截图中的文字提取出来
- 扫描件识别：识别扫描文档中的文字
- 图片转文字：将图片中的菜单、表格等转为文字

### 2. 文档解析

**PDF 解析**：
- 提取所有页面的文本内容
- 保留页数信息
- 自动清理多余空行

**Word 解析**：
- 支持 .docx 格式（现代 Word 格式）
- 提取纯文本内容
- 自动清理格式符号

**Excel 解析**：
- 支持多工作表
- 转换为 CSV 格式（易于 AI 理解）
- 保留表格结构

### 3. 降级策略

当文件解析失败时，系统会自动降级：

1. **智能解析失败** → 尝试读取原始文本
2. **读取原始文本失败** → 只发送文件名和错误提示

确保即使解析失败，用户也能知道上传了什么文件。

---

## 性能参考

| 文件大小 | 处理时间 | 说明 |
|---------|---------|------|
| 小文件 (< 1MB) | < 1 秒 | 立即完成 |
| 中等文件 (1-10MB) | < 5 秒 | 正常等待 |
| 大文件 (10-50MB) | < 15 秒 | 稍等片刻 |
| 超大文件 (> 50MB) | 不建议 | 可能超出限制 |

**OCR 识别时间**：
- 首次使用：10-15 秒（需下载语言包 ~13MB）
- 后续使用：3-10 秒（语言包已缓存）

---

## 使用方法

### 方式 1：通过界面

1. 点击输入框的"附件"按钮（📎 图标）
2. 选择一个或多个文件
3. 点击"发送"按钮
4. 小白AI 会自动解析文件内容

### 方式 2：通过截图

1. 点击"截图"按钮（📷 图标）
2. 选择截图区域
3. 小白AI 会自动识别截图中的文字

---

## 技术实现

### 架构设计

```
用户上传文件
    ↓
前端（InputArea.jsx）
    ↓
IPC 通信
    ↓
主进程（agent.js）
    ↓
fileParser.js（智能解析）
    ├─ 图片 → Tesseract.js（OCR）
    ├─ PDF → pdf-parse
    ├─ Word → mammoth
    ├─ Excel → xlsx
    └─ 文本 → fs.readFile
    ↓
整合到消息内容
    ↓
发送给 Claude API
```

### 核心文件

- `electron/fileParser.js` - 文件解析器（新建）
- `electron/agent.js` - 集成解析器到消息发送流程
- `package.json` - 依赖管理

### 关键依赖

```json
{
  "dependencies": {
    "tesseract.js": "^5.0.0",  // OCR 文字识别
    "pdf-parse": "^1.1.1",      // PDF 解析
    "mammoth": "^1.6.0",        // Word 解析
    "xlsx": "^0.18.5"           // Excel 解析
  }
}
```

### 跨平台兼容性

所有依赖都是纯 JavaScript 实现，无需 native 编译：

- ✅ macOS (Intel/ARM) - 完美支持
- ✅ Windows (x64/ARM) - 完美支持
- ✅ Linux - 完美支持

---

## 常见问题

### Q1: 首次使用 OCR 很慢？

**A**: 首次使用需要下载 Tesseract.js 语言包（~13MB），会自动缓存到本地。后续使用会快很多。

**优化建议**：
- 确保网络连接正常
- 耐心等待下载完成（仅一次）
- 语言包会永久缓存，无需重复下载

### Q2: OCR 识别不准确？

**A**: 识别准确率受图片质量影响较大。

**提升准确率的方法**：
- 使用清晰、高分辨率的图片
- 确保文字对比度高（黑字白底）
- 避免模糊、倾斜、扭曲的图片
- 避免手写文字（打印效果更好）

### Q3: 支持旧版 Word (.doc) 格式吗？

**A**: 不支持。只支持现代 .docx 格式。

**解决方案**：
- 在 Word 中打开 .doc 文件
- 另存为 .docx 格式
- 重新上传

### Q4: Excel 表格格式会保留吗？

**A**: 会保留表格结构，但以 CSV 格式呈现。

**说明**：
- 多工作表会分别标注
- 表格内容转为 CSV（逗号分隔）
- AI 可以理解表格数据

### Q5: 文件太大怎么办？

**A**: 建议文件大小不超过 50MB。

**原因**：
- 大文件处理时间长
- 可能占用较多内存
- 超过 Claude API 限制

**解决方案**：
- 压缩文件后再上传
- 分割大文件为多个小文件
- 对于 PDF/Word，可以只上传相关页面

### Q6: 解析失败怎么办？

**A**: 系统会自动降级，不会完全失败。

**降级流程**：
1. 智能解析失败 → 尝试读取原始文本
2. 读取原始文本失败 → 只发送文件名和错误提示

**如果仍然失败**：
- 检查文件是否损坏
- 确认文件格式是否支持
- 尝试另存为其他格式

---

## 最佳实践

### 1. 图片上传

**推荐**：
- 高分辨率截图（1920x1080 或更高）
- 清晰的打印文字
- 良好的对比度

**不推荐**：
- 模糊的截图
- 手写文字
- 复杂背景（影响 OCR）

### 2. 文档上传

**推荐**：
- PDF：使用文本 PDF（非扫描版）
- Word：使用 .docx 格式
- Excel：简化表格结构

**不推荐**：
- 扫描版 PDF（需要 OCR，较慢）
- 复杂格式的 Word（可能丢失格式）
- 巨大的 Excel 文件（> 10MB）

### 3. 批量上传

**建议**：
- 一次性上传不超过 5 个文件
- 总文件大小不超过 20MB
- 同类型文件一起上传（便于理解）

---

## 更新日志

### v2.20.5 (2026-01-10)

**新增**：
- ✨ 智能文件解析功能
- ✨ 图片 OCR 文字识别
- ✨ PDF/Word/Excel 文档解析
- ✨ 降级策略（解析失败时自动降级）

**优化**：
- 🚀 提升文件上传体验
- 🚀 增强 AI 对文件内容的理解能力

**跨平台**：
- ✅ Windows/Mac/Linux 完美兼容
- ✅ 纯 JavaScript 实现，无需 native 编译

---

## 开发者指南

如果需要扩展文件解析功能，请参考：

**添加新的文件格式支持**：

1. 在 `electron/fileParser.js` 中添加解析函数
2. 在 `detectFileType()` 中添加扩展名映射
3. 在 `parseFile()` 的 switch 中添加新分支

**示例**：

```javascript
// 1. 添加解析函数
async function parsePowerPoint(filePath) {
  // 实现解析逻辑
}

// 2. 添加扩展名映射
function detectFileType(filePath) {
  const typeMap = {
    // ... 现有映射
    '.pptx': 'powerpoint',
  };
  return typeMap[ext] || 'unknown';
}

// 3. 添加到 switch
async function parseFile(filePath) {
  switch (fileType) {
    // ... 现有 case
    case 'powerpoint':
      return await parsePowerPoint(filePath);
  }
}
```

---

**最后更新**: 2026-01-10
**相关文档**:
- [System Architecture](./07-system-architecture.md) - 整体架构
- [Development Guidelines](./09-development-guidelines.md) - 开发规范
