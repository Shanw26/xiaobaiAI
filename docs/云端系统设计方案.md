# 小白AI 云端数据管理系统设计方案

## 📊 系统架构概览

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│  Electron   │◄───────►│   阿里云ECS  │◄───────►│   阿里云RDS │
│   客户端    │  HTTPS  │  (API服务器) │  SQL    │  (MySQL)   │
└─────────────┘         └──────────────┘         └─────────────┘
                              │
                              ├─ 用户认证
                              ├─ 数据同步
                              ├─ API Key管理
                              └─ 统计分析
```

---

## 🎯 核心功能模块

### 1. 用户认证系统
- **手机号登录**（验证码验证）
- **JWT Token** 认证
- **Token 自动刷新**
- **登录状态持久化**

### 2. 数据同步系统
- **对话历史同步**
  - 上传本地对话到云端
  - 下载云端对话到本地
  - 冲突解决策略（时间戳优先）

- **配置同步**
  - 用户 API Key
  - 模型偏好设置
  - 界面主题设置

### 3. 统计分析系统
- **用户行为统计**
  - 使用次数、使用时长
  - 活跃时间段
  - 功能使用频率

- **模型使用统计**
  - Token 消耗量
  - 模型分布
  - 成本分析

### 4. API Key 管理系统
- **官方 API Key 池**
  - 集中管理在云端
  - 游客模式使用
  - 使用限额控制

- **用户 API Key**
  - 安全加密存储
  - 跨设备同步
  - 余额查询（如果 API 提供）

---

## 💾 数据库设计（MySQL）

### 表结构

#### 1. users（用户表）
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  phone VARCHAR(20) UNIQUE NOT NULL,
  password_hash VARCHAR(255), -- 可选，如果支持密码登录
  nickname VARCHAR(50),
  avatar_url VARCHAR(255),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_login_at DATETIME,
  last_active_at DATETIME,
  status ENUM('active', 'banned', 'deleted') DEFAULT 'active',
  INDEX idx_phone (phone),
  INDEX idx_status (status)
);
```

#### 2. user_tokens（用户Token表）
```sql
CREATE TABLE user_tokens (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  token_hash VARCHAR(255) NOT NULL,
  device_id VARCHAR(64),
  device_info TEXT, -- JSON格式：{"platform":"darwin","arch":"arm64"}
  expires_at DATETIME NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_token (token_hash),
  INDEX idx_user_device (user_id, device_id)
);
```

#### 3. user_api_keys（用户API Key表）
```sql
CREATE TABLE user_api_keys (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  provider ENUM('anthropic', 'zhipu') NOT NULL,
  api_key_encrypted TEXT NOT NULL, -- AES加密
  key_name VARCHAR(50),
  is_default BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_provider (user_id, provider)
);
```

#### 4. conversations（对话历史表）
```sql
CREATE TABLE conversations (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  device_id VARCHAR(64),
  title VARCHAR(200),
  model VARCHAR(50),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_created (user_id, created_at DESC),
  INDEX idx_device (device_id)
);
```

#### 5. messages（消息表）
```sql
CREATE TABLE messages (
  id VARCHAR(36) PRIMARY KEY,
  conversation_id VARCHAR(36) NOT NULL,
  role ENUM('user', 'assistant', 'system') NOT NULL,
  content TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
  INDEX idx_conversation (conversation_id, created_at)
);
```

#### 6. usage_statistics（使用统计表）
```sql
CREATE TABLE usage_statistics (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  device_id VARCHAR(64),
  model VARCHAR(50),
  input_tokens INT DEFAULT 0,
  output_tokens INT DEFAULT 0,
  total_tokens INT DEFAULT 0,
  request_duration INT, -- 请求耗时（毫秒）
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_date (user_id, created_at),
  INDEX idx_model_date (model, created_at)
);
```

#### 7. guest_usage（游客使用记录表）
```sql
CREATE TABLE guest_usage (
  device_id VARCHAR(64) PRIMARY KEY,
  used_count INT DEFAULT 0,
  last_used_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_last_used (last_used_at)
);
```

#### 8. verification_codes（验证码表）
```sql
CREATE TABLE verification_codes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(10) NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  expires_at DATETIME NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_phone_code (phone, code),
  INDEX idx_expires (expires_at)
);
```

#### 9. system_config（系统配置表）
```sql
CREATE TABLE system_config (
  key VARCHAR(50) PRIMARY KEY,
  value TEXT NOT NULL,
  description VARCHAR(255),
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## 🔌 API 接口设计

### 认证相关
- `POST /api/auth/send-code` - 发送验证码
- `POST /api/auth/verify-code` - 验证码登录
- `POST /api/auth/refresh` - 刷新Token
- `POST /api/auth/logout` - 登出

### 用户相关
- `GET /api/user/profile` - 获取用户信息
- `PUT /api/user/profile` - 更新用户信息
- `GET /api/user/stats` - 获取用户统计数据

### API Key 管理
- `GET /api/apikeys` - 获取用户API Key列表
- `POST /api/apikeys` - 添加API Key
- `PUT /api/apikeys/:id` - 更新API Key
- `DELETE /api/apikeys/:id` - 删除API Key

### 对话同步
- `GET /api/conversations` - 获取对话列表
- `GET /api/conversations/:id` - 获取对话详情
- `POST /api/conversations` - 创建对话
- `PUT /api/conversations/:id` - 更新对话
- `DELETE /api/conversations/:id` - 删除对话
- `POST /api/conversations/sync` - 同步对话（本地→云端 / 云端→本地）

### 统计数据
- `POST /api/stats/usage` - 上报使用统计
- `GET /api/stats/dashboard` - 获取统计数据面板

### 游客模式
- `GET /api/guest/check` - 检查游客可用次数
- `POST /api/guest/increment` - 增加游客使用次数

---

## 🔐 安全措施

### 1. 数据加密
- **传输加密**：HTTPS (TLS 1.3)
- **存储加密**：
  - API Key 使用 AES-256-GCM 加密
  - 密码使用 bcrypt 哈希
  - 敏感字段加密存储

### 2. 认证安全
- **JWT Token**：有效期 7 天，Refresh Token 30 天
- **Token 黑名单**：登出后加入 Redis 黑名单
- **设备指纹**：绑定设备ID，防止Token盗用

### 3. API 限流
- **验证码**：每分钟最多 3 次
- **登录**：每小时最多 5 次
- **API 调用**：每分钟最多 100 次

### 4. 数据备份
- **每日备份**：阿里云 RDS 自动备份
- **异地容灾**：跨地域备份
- **恢复测试**：每月演练一次

---

## 🚀 部署方案（阿里云）

### 服务器配置
- **ECS**：2核4GB（起步）
- **操作系统**：Ubuntu 22.04 LTS
- **带宽**：5Mbps（按使用量计费）
- **月成本**：约 ¥100-200

### 数据库配置
- **RDS MySQL**：2核4GB
- **存储**：20GB SSD
- **月成本**：约 ¥150-300

### 软件栈
- **Node.js** 20.x LTS
- **MySQL** 8.0
- **Nginx** 1.24（反向代理）
- **PM2**（进程管理）

---

## 📅 实施步骤

### 阶段1：API 服务开发（3-5天）
1. 搭建 Node.js + Express 项目
2. 实现用户认证系统
3. 实现 API Key 管理接口
4. 实现对话同步接口
5. 实现统计接口

### 阶段2：数据库部署（1天）
1. 购买阿里云 RDS MySQL
2. 创建数据库和表结构
3. 配置安全组规则
4. 测试连接

### 阶段3：服务器部署（1天）
1. 购买阿里云 ECS
2. 安装 Node.js + PM2 + Nginx
3. 部署 API 服务
4. 配置域名 + SSL证书

### 阶段4：客户端改造（2-3天）
1. 添加云端同步模块
2. 修改用户系统逻辑
3. 添加数据上报功能
4. 测试同步功能

### 阶段5：测试上线（1天）
1. 功能测试
2. 性能测试
3. 安全测试
4. 灰度发布

---

## 💰 成本预估

### 初期（月）
- ECS：¥150
- RDS：¥200
- 流量费：¥50
- **总计：约 ¥400/月**

### 扩展后（1000+ 用户）
- ECS：4核8GB ¥400
- RDS：4核8GB ¥600
- 流量费：¥200
- **总计：约 ¥1200/月**

---

## 🎉 优势

✅ **数据安全**：云端备份，数据不丢失
✅ **多设备同步**：随时随地访问数据
✅ **用户洞察**：了解用户行为，优化产品
✅ **成本控制**：集中管理 API Key，避免滥用
✅ **扩展性强**：支持更多设备类型（Web、移动端）

---

**文档版本**：v1.0
**最后更新**：2026-01-06
