# v2.10.13 - 从 Supabase 获取 API Key 安全改进

> **发布日期**: 2026-01-08
> **安全级别**: 🔒 重大安全更新
> **影响范围**: 游客模式 API Key 管理

---

## 📋 变更概述

**核心改进**: 移除硬编码的 API Key，改为从 Supabase 远程获取，大幅提升安全性。

---

## 🔒 安全问题修复

### 之前的设计（v2.10.12 及之前）

```javascript
// ❌ 硬编码在源代码中
const officialApiKey = process.env.ZHIPU_OFFICIAL_API_KEY ||
                       'c2204ed0321b40a78e7f8b6eda93ff39.h9MOF4P51SCQpPhI';
```

**安全风险**：
- 🔴 代码泄露 = API Key 泄露
- 🔴 GitHub 仓库历史包含 Key
- 🔴 员工电脑、备份都可能泄露
- 🔴 无法快速轮换 Key

### 新的设计（v2.10.13）

```javascript
// ✅ 从 Supabase 远程获取
async function fetchOfficialConfigFromSupabase() {
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const { data } = await supabase.rpc('get_system_config', {
    p_key: 'official_api_key'
  });

  return data[0].value;
}
```

**安全优势**：
- ✅ API Key 不在源代码中
- ✅ 可以随时在 Supabase 中更换
- ✅ 集中管理，易于运维
- ✅ 支持密钥轮换

---

## 📁 文件变更

### 新增文件

1. **supabase/migrations/20260108_add_system_configs.sql**
   - 创建 `system_configs` 表
   - 设置 RLS 策略（所有人可读，不可修改）
   - 创建安全函数 `get_system_config()`

2. **docs/从Supabase获取API密钥配置指南.md**
   - 完整的配置指南
   - 安全设计说明
   - 常见问题解答

### 修改文件

1. **electron/database.js**
   - 新增 `fetchOfficialConfigFromSupabase()` 函数
   - 修改 `initOfficialConfig()` 为异步函数
   - 移除硬编码的 API Key

2. **electron/main.js**
   - 修改调用为 `await db.initOfficialConfig()`
   - 添加错误处理

3. **package.json**
   - 版本号: 2.10.12 → 2.10.13

4. **src/components/Sidebar.jsx**
   - 版本号: v2.10.12 → v2.10.13

5. **src/components/SettingsModal.jsx**
   - 版本号: v2.10.12 → v2.10.13

---

## 🚀 部署步骤

### 1. 应用数据库迁移

登录 Supabase 控制台，执行 SQL：

```sql
-- 复制 supabase/migrations/20260108_add_system_configs.sql
-- 粘贴到 SQL Editor 并执行
```

### 2. 插入官方 API Key

```sql
INSERT INTO public.system_configs (key, value, description, is_sensitive)
VALUES
  ('official_api_key', 'YOUR_NEW_KEY_HERE', '官方智谱 GLM API Key（游客模式使用）', true),
  ('official_provider', 'zhipu', '官方模型提供商', false),
  ('official_model', 'glm-4.7', '官方默认模型', false),
  ('free_usage_limit', '10', '游客免费使用次数限制', false)
ON CONFLICT (key) DO UPDATE SET
  value = EXCLUDED.value,
  updated_at = NOW();
```

**⚠️ 重要**：
- 如果旧 Key 已泄露，请先在智谱 AI 控制台删除并生成新 Key
- 将 `YOUR_NEW_KEY_HERE` 替换为新的 API Key

### 3. 重启应用

```bash
npm run dev
```

### 4. 验证

查看启动日志：

```
[启动] 初始化官方配置...
✅ 从 Supabase 成功获取官方配置
  - 模型提供商: zhipu
  - 模型: glm-4.7
  - API Key: xxxxxxxxx...
  - 免费限制: 10 次
✅ 使用 Supabase 配置
[启动] ✓ 官方配置初始化完成
```

---

## 🛡️ 安全设计

### RLS（Row Level Security）

```sql
-- 允许所有人读取
CREATE POLICY "允许所有人读取系统配置"
  ON public.system_configs
  FOR SELECT TO public USING (true);

-- 禁止客户端修改
CREATE POLICY "禁止客户端修改系统配置"
  ON public.system_configs
  FOR ALL TO public USING (false);
```

**效果**：
- ✅ 客户端可以读取配置
- ❌ 客户端无法修改配置
- ✅ 只有 Service Role Key 可以修改

### 配置优先级

```
1. Supabase 远程配置（推荐）⭐
   ↓ 如果失败
2. 环境变量 ZHIPU_OFFICIAL_API_KEY
   ↓ 如果失败
3. 游客模式不可用（显示错误）
```

---

## 🔄 迁移指南

### 旧版本用户（v2.10.12 及之前）

**无影响**：
- 旧版本用户的本地数据库已有配置
- 应用不会重复初始化
- 继续使用本地缓存的配置

**升级建议**：
1. 应用数据库迁移
2. 在 Supabase 中插入新的 API Key
3. 重启应用（可选，不会影响已有配置）

### 新用户

**首次启动**：
1. 应用检查本地数据库
2. 如果没有配置，从 Supabase 获取
3. 写入本地数据库
4. 后续启动直接使用本地缓存

---

## 📊 对比总结

| 方面 | v2.10.12（旧） | v2.10.13（新） |
|-----|---------------|---------------|
| API Key 存储 | 硬编码在源代码 | Supabase 数据库 |
| 安全性 | ⭐⭐ | ⭐⭐⭐⭐ |
| 密钥轮换 | 困难（需重新部署） | 简单（SQL 更新） |
| 泄露风险 | 高 | 低 |
| 运维友好度 | 低 | 高 |
| 降级方案 | 环境变量 | Supabase > 环境变量 |
| 代码泄露影响 | 严重 | 无影响 |

---

## 🎯 后续改进建议

1. **密钥轮换机制**：定期自动更换 API Key
2. **使用监控**：监控 API Key 调用量和异常
3. **多 Key 支持**：配置多个 Key，主 Key 失效时自动切换
4. **限流保护**：在智谱 AI 控制台设置每日额度限制
5. **告警机制**：API Key 异常使用时发送告警

---

## ✅ 检查清单

部署前确认：

- [ ] Supabase 数据库迁移已执行
- [ ] API Key 已插入 `system_configs` 表
- [ ] 旧的 API Key 已在智谱 AI 控制台删除
- [ ] 新的 API Key 已生成
- [ ] 环境变量 `.env` 配置正确
- [ ] 应用已重启并验证日志
- [ ] 游客模式测试通过

---

**维护者**: 晓力
**审核**: Claude Code 安全审计
**文档**: [从Supabase获取API密钥配置指南](./从Supabase获取API密钥配置指南.md)
