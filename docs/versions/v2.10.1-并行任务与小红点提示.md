# v2.10.1 å¹¶è¡Œä»»åŠ¡æ‰§è¡Œä¸å°çº¢ç‚¹æç¤º - æŠ€æœ¯æ–‡æ¡£

**ç‰ˆæœ¬**: v2.10.1
**å‘å¸ƒæ—¥æœŸ**: 2026-01-08
**ä½œè€…**: Claude Code + æ™“åŠ›
**åŠŸèƒ½åˆ†ç±»**: æ ¸å¿ƒåŠŸèƒ½ä¼˜åŒ–

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [éœ€æ±‚èƒŒæ™¯](#éœ€æ±‚èƒŒæ™¯)
3. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
4. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
5. [APIæ–‡æ¡£](#apiæ–‡æ¡£)
6. [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

æœ¬æ¬¡æ›´æ–°å®ç°äº†ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼š

1. **å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ** - æ¯ä¸ªä¼šè¯æ‹¥æœ‰ç‹¬ç«‹çš„Agentå®ä¾‹ï¼Œæ”¯æŒçœŸæ­£çš„å¹¶è¡Œå¤„ç†
2. **å°çº¢ç‚¹æç¤º** - åå°ä»»åŠ¡å®Œæˆæ—¶ï¼Œä¾§è¾¹æ æ˜¾ç¤ºçº¢è‰²å°åœ†ç‚¹é€šçŸ¥ç”¨æˆ·

### åŠŸèƒ½æ¼”ç¤º

```
åœºæ™¯ï¼šç”¨æˆ·åœ¨ä¼šè¯Aæ‰§è¡Œä»»åŠ¡æ—¶ï¼Œåˆ‡æ¢åˆ°ä¼šè¯B

[ä¼šè¯A] ç”¨æˆ·: "å¸®æˆ‘åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„"
         AI: [æ­£åœ¨åˆ†æ...] â† ç”¨æˆ·åˆ‡æ¢åˆ°ä¼šè¯B

[ä¼šè¯B] ç”¨æˆ·: "åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶test.txt"
         AI: "å·²åˆ›å»ºæ–‡ä»¶"

[å‡ åˆ†é’Ÿå] ä¾§è¾¹æ ä¼šè¯Aæ ‡é¢˜åå‡ºç°çº¢è‰²å°åœ†ç‚¹ â—
         ç”¨æˆ·ç‚¹å‡»ä¼šè¯Aï¼Œçº¢ç‚¹æ¶ˆå¤±ï¼Œçœ‹åˆ°å®Œæ•´çš„åˆ†æç»“æœ
```

---

## éœ€æ±‚èƒŒæ™¯

### ç”¨æˆ·æ´å¯Ÿ

> "å°ç™½çš„å¤šçª—å£æ¨¡å¼ï¼Œåœ¨äº¤äº’ä¸Šæ˜¯ä¸æ˜¯å¯ä»¥æ˜¯ã€æ–°ä¼šè¯ã€å°±è¡Œ"

**æ ¸å¿ƒéœ€æ±‚åˆ†æ**ï¼š
- ç”¨æˆ·ä¸éœ€è¦çœŸæ­£çš„å¤šçª—å£ï¼Œè€Œæ˜¯éœ€è¦å¹¶è¡Œå¤„ç†èƒ½åŠ›
- "æ–°ä¼šè¯"å·²ç»å®ç°äº†ä»»åŠ¡éš”ç¦»ï¼ˆæ•°æ®å±‚é¢ï¼‰
- ç¼ºå°‘çš„æ˜¯å¹¶è¡Œå¤„ç†ï¼ˆæ‰§è¡Œå±‚é¢ï¼‰

### æŠ€æœ¯æŒ‘æˆ˜

**åŸæœ‰æ¶æ„é—®é¢˜**ï¼š
```javascript
// v2.10.1 ä¹‹å‰ï¼šå•ä¸€å…¨å±€Agentå®ä¾‹
let agentInstance = null;  // æ‰€æœ‰ä¼šè¯å…±äº«åŒä¸€ä¸ªAgent

// é—®é¢˜ï¼š
// 1. ä¼šè¯Açš„ä»»åŠ¡æ‰§è¡Œä¸­ï¼Œä¼šè¯Bå¿…é¡»ç­‰å¾…
// 2. æ— æ³•å®ç°çœŸæ­£çš„å¹¶è¡Œå¤„ç†
// 3. ç”¨æˆ·ä½“éªŒå—é™äºä¸²è¡Œå¤„ç†
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// v2.10.1 ä¹‹åï¼šæ¯ä¸ªä¼šè¯ç‹¬ç«‹çš„Agentå®ä¾‹
const conversationAgents = new Map(); // conversationId -> Agent

// ä¼˜åŠ¿ï¼š
// 1. æ¯ä¸ªä¼šè¯ç‹¬ç«‹Agentï¼Œäº’ä¸å¹²æ‰°
// 2. çœŸæ­£çš„å¹¶è¡Œå¤„ç†
// 3. ç”¨æˆ·ä½“éªŒæå‡
```

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å°ç™½AI v2.10.1                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   ä¼šè¯ A       â”‚      â”‚   ä¼šè¯ B       â”‚            â”‚
â”‚  â”‚  "åˆ†æä»£ç "    â”‚      â”‚  "åˆ›å»ºæ–‡ä»¶"    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                       â”‚                      â”‚
â”‚          â–¼                       â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Agent Instance Aâ”‚     â”‚ Agent Instance Bâ”‚            â”‚
â”‚  â”‚  (ç‹¬ç«‹å¤„ç†)     â”‚     â”‚  (ç‹¬ç«‹å¤„ç†)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                       â”‚                      â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â–¼                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â”‚  Claude API      â”‚                        â”‚
â”‚            â”‚  (å¹¶è¡Œè¯·æ±‚)       â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â”‚                                  â”‚
â”‚                      â–¼                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â”‚ æ¶ˆæ¯å®Œæˆé€šçŸ¥      â”‚                        â”‚
â”‚            â”‚ IPC Event        â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â”‚                                  â”‚
â”‚                      â–¼                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â”‚  å‰ç«¯çŠ¶æ€ç®¡ç†     â”‚                        â”‚
â”‚            â”‚  unreadConversationsâ”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                      â”‚                                  â”‚
â”‚                      â–¼                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚            â”‚  ä¾§è¾¹æ çº¢ç‚¹æ˜¾ç¤º   â”‚                        â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå›¾

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š

1. åˆ›å»ºä¼šè¯A â†’ Agent Aåˆ›å»º â†’ å‘é€æ¶ˆæ¯ â†’ [å¤„ç†ä¸­...]
2. åˆ‡æ¢åˆ°ä¼šè¯B â†’ Agent Båˆ›å»º â†’ å‘é€æ¶ˆæ¯ â†’ [å¹¶è¡Œå¤„ç†ä¸­...]
3. ä¼šè¯Aå®Œæˆ â†’ IPCäº‹ä»¶è§¦å‘ â†’ å‰ç«¯æ”¶åˆ°é€šçŸ¥
4. åˆ¤æ–­ï¼šcurrentChatId !== conversationId â†’ æ·»åŠ åˆ°unreadConversations
5. ä¾§è¾¹æ æ¸²æŸ“ï¼šæ£€æŸ¥ unreadConversations.has(conv.id) â†’ æ˜¾ç¤ºçº¢ç‚¹
6. ç”¨æˆ·ç‚¹å‡»ä¼šè¯A â†’ ä»unreadConversationsç§»é™¤ â†’ çº¢ç‚¹æ¶ˆå¤±
```

---

## å®ç°ç»†èŠ‚

### 1. åç«¯æ”¹é€  (electron/main.js)

#### 1.1 æ•°æ®ç»“æ„å˜æ›´

**ä½ç½®**: `electron/main.js:35-36`

```javascript
// v2.10.1 ä¹‹å‰
let agentInstance = null;

// v2.10.1 ä¹‹å
let agentInstance = null;  // å…¨å±€é»˜è®¤Agentï¼ˆå‘åå…¼å®¹ï¼‰
const conversationAgents = new Map();  // conversationId -> Agentå®ä¾‹ï¼ˆv2.10.1æ–°å¢ï¼šæ”¯æŒå¹¶è¡Œä»»åŠ¡ï¼‰
```

#### 1.2 æ¶ˆæ¯å‘é€Handleræ”¹é€ 

**ä½ç½®**: `electron/main.js:914-1042`

```javascript
ipcMain.handle('send-message', async (event, conversationId, message, files) => {
  // âœ¨ v2.10.1 æ”¹è¿›ï¼šè·å–æˆ–åˆ›å»ºè¯¥ä¼šè¯çš„ç‹¬ç«‹Agentå®ä¾‹
  let targetAgent = conversationAgents.get(conversationId);

  if (!targetAgent) {
    // åˆ›å»ºæ–°çš„Agentå®ä¾‹ï¼ˆç‹¬ç«‹äºå…¶ä»–ä¼šè¯ï¼‰
    targetAgent = await agent.createAgent(
      agentInstance.provider,
      agentInstance.apiKey,
      agentInstance.model
    );
    conversationAgents.set(conversationId, targetAgent);
    console.log(`âœ… [å¹¶è¡Œä»»åŠ¡] ä¸ºä¼šè¯ ${conversationId} åˆ›å»ºç‹¬ç«‹Agentå®ä¾‹`);
  }

  // ä½¿ç”¨ç‹¬ç«‹çš„Agentå®ä¾‹å¤„ç†æ¶ˆæ¯ï¼ˆä¸é˜»å¡å…¶ä»–ä¼šè¯ï¼‰
  const result = await agent.sendMessage(targetAgent, message, fileInfos, ...);

  // âœ¨ v2.10.1 æ–°å¢ï¼šå‘é€æ¶ˆæ¯å®Œæˆé€šçŸ¥
  mainWindow.webContents.send('message-completed', {
    conversationId: activeConversationId,
    timestamp: Date.now()
  });
  console.log(`âœ… [å¹¶è¡Œä»»åŠ¡] ä¼šè¯ ${conversationId} æ¶ˆæ¯å¤„ç†å®Œæˆ`);

  return result;
});
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `Map` æ•°æ®ç»“æ„ç®¡ç†å¤šä¸ªAgentå®ä¾‹
- æ¯ä¸ªä¼šè¯é¦–æ¬¡å‘é€æ¶ˆæ¯æ—¶åˆ›å»ºç‹¬ç«‹çš„Agent
- Agentå®ä¾‹å¤ç”¨ï¼šåŒä¸€ä¼šè¯çš„åç»­æ¶ˆæ¯ä½¿ç”¨åŒä¸€ä¸ªAgent
- å‘é€IPCäº‹ä»¶é€šçŸ¥å‰ç«¯æ¶ˆæ¯å®Œæˆ

---

### 2. IPCé€šä¿¡å±‚ (electron/preload.js)

#### 2.1 sendMessageæ¥å£æ”¹é€ 

**ä½ç½®**: `electron/preload.js:42`

```javascript
// v2.10.1 ä¹‹å‰
sendMessage: (message, files) => ipcRenderer.invoke('send-message', message, files),

// v2.10.1 ä¹‹å
sendMessage: (conversationId, message, files) =>
  ipcRenderer.invoke('send-message', conversationId, message, files),
```

**å‘åå…¼å®¹å¤„ç†**ï¼š
å‰ç«¯è°ƒç”¨æ—¶å¿…é¡»ä¼ é€’ `conversationId`ï¼Œç¡®ä¿æ¶ˆæ¯å‘é€åˆ°æ­£ç¡®çš„Agentå®ä¾‹ã€‚

#### 2.2 æ¶ˆæ¯å®Œæˆäº‹ä»¶ç›‘å¬

**ä½ç½®**: `electron/preload.js:90-92`

```javascript
// âœ¨ v2.10.1 æ–°å¢ï¼šç›‘å¬æ¶ˆæ¯å®Œæˆäº‹ä»¶ï¼ˆå°çº¢ç‚¹æç¤ºï¼‰
onMessageCompleted: (callback) =>
  ipcRenderer.on('message-completed', (event, data) => callback(data)),

removeMessageCompletedListener: () =>
  ipcRenderer.removeAllListeners('message-completed'),
```

**äº‹ä»¶æ•°æ®æ ¼å¼**ï¼š
```javascript
{
  conversationId: "1234567890",  // å®Œæˆä»»åŠ¡çš„ä¼šè¯ID
  timestamp: 1704700800000       // å®Œæˆæ—¶é—´æˆ³
}
```

---

### 3. å‰ç«¯çŠ¶æ€ç®¡ç† (src/App.jsx)

#### 3.1 çŠ¶æ€å®šä¹‰

**ä½ç½®**: `src/App.jsx:55-56`

```javascript
// âœ¨ v2.10.1 æ–°å¢ï¼šæœªè¯»ä¼šè¯çŠ¶æ€ç®¡ç†
const [unreadConversations, setUnreadConversations] = useState(new Set());
```

**ä½¿ç”¨Setçš„åŸå› **ï¼š
- `O(1)` æ—¶é—´å¤æ‚åº¦çš„æŸ¥æ‰¾æ“ä½œ
- è‡ªåŠ¨å»é‡
- å†…å­˜é«˜æ•ˆ

#### 3.2 ç›‘å¬æ¶ˆæ¯å®Œæˆäº‹ä»¶

**ä½ç½®**: `src/App.jsx:298-320`

```javascript
useEffect(() => {
  const handleMessageCompleted = (data) => {
    const { conversationId, timestamp } = data;

    console.log(`ğŸ”” [å°çº¢ç‚¹] æ”¶åˆ°æ¶ˆæ¯å®Œæˆé€šçŸ¥:`, {
      conversationId,
      currentChatId,
      timestamp: new Date(timestamp).toLocaleString()
    });

    // åªå¯¹éæ´»è·ƒä¼šè¯æ˜¾ç¤ºçº¢ç‚¹
    if (conversationId !== currentChatId) {
      setUnreadConversations(prev => {
        const newSet = new Set(prev);
        newSet.add(conversationId);
        console.log(`ğŸ”´ [å°çº¢ç‚¹] æ·»åŠ çº¢ç‚¹: ${conversationId}`);
        return newSet;
      });
    } else {
      console.log(`âœ… [å°çº¢ç‚¹] å½“å‰ä¼šè¯ï¼Œä¸æ˜¾ç¤ºçº¢ç‚¹`);
    }
  };

  window.electronAPI.onMessageCompleted(handleMessageCompleted);

  // æ¸…ç†å‡½æ•°ï¼šç§»é™¤äº‹ä»¶ç›‘å¬å™¨
  return () => {
    if (window.electronAPI.removeMessageCompletedListener) {
      window.electronAPI.removeMessageCompletedListener();
    }
  };
}, [currentChatId]);  // ä¾èµ– currentChatIdï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®
```

**å…³é”®é€»è¾‘**ï¼š
- åªå¯¹éæ´»è·ƒä¼šè¯æ˜¾ç¤ºçº¢ç‚¹
- ä½¿ç”¨ `useEffect` æ¸…ç†å‡½æ•°é¿å…å†…å­˜æ³„æ¼
- ä¾èµ– `currentChatId`ï¼ŒåŠ¨æ€åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºçº¢ç‚¹

#### 3.3 åˆ‡æ¢ä¼šè¯æ—¶æ¸…é™¤çº¢ç‚¹

**ä½ç½®**: `src/App.jsx:659-668`

```javascript
const handleSelectChat = (chatId) => {
  console.log(`ğŸ”„ [åˆ‡æ¢ä¼šè¯] ä» ${currentChatId} åˆ‡æ¢åˆ° ${chatId}`);

  setCurrentChatId(chatId);

  // âœ¨ v2.10.1 ä¼˜åŒ–ï¼šæ¸…é™¤è¯¥ä¼šè¯çš„çº¢ç‚¹
  setUnreadConversations(prev => {
    const newSet = new Set(prev);
    if (newSet.has(chatId)) {
      newSet.delete(chatId);
      console.log(`âœ… [å°çº¢ç‚¹] æ¸…é™¤çº¢ç‚¹: ${chatId}`);
    }
    return newSet;
  });
};
```

#### 3.4 sendMessageä¼ é€’conversationId

**ä½ç½®**: `src/App.jsx:898`

```javascript
const result = await window.electronAPI.sendMessage(
  chat.id,  // âœ¨ v2.10.1 ä¼ é€’ conversationId
  fullContent,
  files
);
```

#### 3.5 message-deltaæ”¯æŒå¹¶è¡Œæ›´æ–°

**ä½ç½®**: `src/App.jsx:236-262`

```javascript
window.electronAPI.onMessageDelta(({ conversationId, text, fullText }) => {
  // âœ¨ v2.10.1 ä¼˜åŒ–ï¼šä½¿ç”¨ conversationId æ‰¾åˆ°æ­£ç¡®çš„ä¼šè¯
  setConversations((prev) => {
    const newConversations = [...prev];
    const targetChat = newConversations.find((c) => c.id === conversationId);

    if (targetChat) {
      const lastMessage = targetChat.messages[targetChat.messages.length - 1];
      if (lastMessage && lastMessage.role === 'assistant') {
        lastMessage.content = fullText;
      }
    }

    return newConversations;
  });
});
```

**å…³é”®æ”¹è¿›**ï¼š
- ä½¿ç”¨ `conversationId` ç²¾ç¡®å®šä½ä¼šè¯
- é¿å…å¹¶è¡Œä»»åŠ¡æ—¶çš„æ¶ˆæ¯æ··æ·†
- ç¡®ä¿æµå¼å“åº”æ›´æ–°åˆ°æ­£ç¡®çš„ä¼šè¯

---

### 4. UIæ˜¾ç¤ºå±‚ (src/components/Sidebar.jsx)

#### 4.1 æ¥æ”¶unreadConversationså±æ€§

**ä½ç½®**: `src/components/Sidebar.jsx:18-27`

```javascript
function Sidebar({
  conversations,
  currentChatId,
  onNewChat,
  onSelectChat,
  onDeleteChat,
  onOpenSettings,
  currentUser,
  unreadConversations,  // âœ¨ v2.10.1 æ–°å¢ï¼šæœªè¯»ä¼šè¯ï¼ˆå°çº¢ç‚¹ï¼‰
}) {
```

#### 4.2 æ˜¾ç¤ºçº¢ç‚¹å¾½ç« 

**ä½ç½®**: `src/components/Sidebar.jsx:80-91`

```javascript
<div className="chat-item-title">
  {conv.title}
  {/* âœ¨ v2.10.1 æ–°å¢ï¼šå°çº¢ç‚¹æç¤ºï¼ˆåå°å®Œæˆå›å¤ï¼‰ */}
  {unreadConversations?.has(conv.id) && (
    <span className="unread-badge">â—</span>
  )}
</div>
```

**æ¸²æŸ“é€»è¾‘**ï¼š
- ä½¿ç”¨ `has()` æ–¹æ³•æ£€æŸ¥ä¼šè¯æ˜¯å¦æœªè¯»ï¼ˆ`O(1)` å¤æ‚åº¦ï¼‰
- å¯é€‰é“¾ `?.` é˜²æ­¢ `undefined` é”™è¯¯
- æ¡ä»¶æ¸²æŸ“ï¼šåªåœ¨æœªè¯»æ—¶æ˜¾ç¤ºçº¢ç‚¹

---

### 5. æ ·å¼å±‚ (src/components/Sidebar.css)

#### 5.1 å°çº¢ç‚¹æ ·å¼

**ä½ç½®**: `src/components/Sidebar.css:180-199`

```css
/* âœ¨ v2.10.1 æ–°å¢ï¼šæœªè¯»æ¶ˆæ¯å°çº¢ç‚¹æ ·å¼ */
.unread-badge {
  color: #ff4444;                /* é†’ç›®çš„çº¢è‰² */
  margin-left: 6px;              /* ä¸æ ‡é¢˜çš„é—´è· */
  font-size: 10px;               /* å¤§å°é€‚ä¸­ï¼Œä¸çªå…€ */
  animation: pulse 2s ease-in-out infinite;  /* å‘¼å¸åŠ¨ç”» */
  display: inline-block;
  vertical-align: middle;
}

/* å‘¼å¸åŠ¨ç”»ï¼šå‘¨æœŸæ€§æ”¾å¤§ç¼©å° */
@keyframes pulse {
  0%, 100% {
    opacity: 1;        /* å®Œå…¨ä¸é€æ˜ */
    transform: scale(1);  /* åŸå§‹å¤§å° */
  }
  50% {
    opacity: 0.6;      /* åŠé€æ˜ */
    transform: scale(1.1);  /* æ”¾å¤§10% */
  }
}
```

**è®¾è®¡ç†å¿µ**ï¼š
- **é¢œè‰²**ï¼šçº¢è‰² (`#ff4444`) - ç´§æ€¥æ„Ÿå’Œé‡è¦æ€§
- **å¤§å°**ï¼š10px - æ˜¾çœ¼ä½†ä¸å æ®å¤ªå¤šç©ºé—´
- **åŠ¨ç”»**ï¼š2ç§’å‘¨æœŸè„‰å†² - å¸å¼•æ³¨æ„åŠ›ä½†ä¸è¿‡åˆ†å¹²æ‰°
- **ç¼©æ”¾**ï¼š1.0 â†’ 1.1 - å¾®å¦™çš„è§†è§‰æç¤º
- **é€æ˜åº¦**ï¼š1.0 â†’ 0.6 - æŸ”å’Œçš„å˜åŒ–

---

## APIæ–‡æ¡£

### IPCæ¥å£

#### sendMessage

**å‘é€æ¶ˆæ¯åˆ°AI**

```javascript
// è¯­æ³•
await window.electronAPI.sendMessage(conversationId, message, files);

// å‚æ•°
conversationId: string  // ä¼šè¯ID
message: string         // æ¶ˆæ¯å†…å®¹
files: Array           // æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰

// è¿”å›å€¼
{
  success: boolean,
  error?: string,
  data?: any
}
```

#### onMessageCompleted

**ç›‘å¬æ¶ˆæ¯å®Œæˆäº‹ä»¶**

```javascript
// è¯­æ³•
window.electronAPI.onMessageCompleted(callback);

// å›è°ƒå‚æ•°
callback(data: {
  conversationId: string,  // å®Œæˆçš„ä¼šè¯ID
  timestamp: number        // å®Œæˆæ—¶é—´æˆ³
});

// æ¸…ç†ç›‘å¬å™¨
window.electronAPI.removeMessageCompletedListener();
```

### Reactç»„ä»¶æ¥å£

#### Sidebarç»„ä»¶

```javascript
<Sidebar
  conversations={conversations}
  currentChatId={currentChatId}
  onNewChat={handleNewChat}
  onSelectChat={handleSelectChat}
  onDeleteChat={handleDeleteChat}
  onOpenSettings={() => setShowSettings(true)}
  currentUser={currentUser}
  unreadConversations={unreadConversations}  // âœ¨ v2.10.1 æ–°å¢
/>
```

**Propsè¯´æ˜**ï¼š
- `unreadConversations`: `Set<string>` - æœªè¯»ä¼šè¯IDé›†åˆ

---

## æµ‹è¯•æŒ‡å—

### åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•åœºæ™¯1ï¼šå¹¶è¡Œä»»åŠ¡æ‰§è¡Œ

**æ­¥éª¤**ï¼š
1. æ‰“å¼€å°ç™½AIåº”ç”¨
2. ç‚¹å‡»"æ–°å¯¹è¯"åˆ›å»ºä¼šè¯A
3. å‘é€æ¶ˆæ¯ï¼š"å¸®æˆ‘åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„"ï¼ˆé•¿ä»»åŠ¡ï¼‰
4. ç­‰å¾…AIå¼€å§‹å›å¤åï¼Œç‚¹å‡»"æ–°å¯¹è¯"åˆ›å»ºä¼šè¯B
5. åœ¨ä¼šè¯Bä¸­å‘é€æ¶ˆæ¯ï¼š"åˆ›å»ºä¸€ä¸ªtest.txtæ–‡ä»¶"
6. è§‚å¯Ÿä¸¤ä¸ªä¼šè¯æ˜¯å¦åŒæ—¶å¤„ç†

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¼šè¯Aå’Œä¼šè¯BåŒæ—¶å¤„ç†æ¶ˆæ¯
- âœ… ä¼šè¯Bä¸éœ€è¦ç­‰å¾…ä¼šè¯Aå®Œæˆ
- âœ… ä¸¤ä¸ªä¼šè¯çš„æ¶ˆæ¯ç‹¬ç«‹æ˜¾ç¤ºï¼Œäº’ä¸å¹²æ‰°

#### æµ‹è¯•åœºæ™¯2ï¼šå°çº¢ç‚¹æç¤º

**æ­¥éª¤**ï¼š
1. åœ¨ä¼šè¯Aä¸­å‘é€ä¸€ä¸ªé•¿ä»»åŠ¡
2. ç­‰å¾…AIå¼€å§‹å›å¤åï¼Œåˆ‡æ¢åˆ°ä¼šè¯B
3. åœ¨ä¼šè¯Bä¸­è¿›è¡Œå…¶ä»–æ“ä½œ
4. ç­‰å¾…ä¼šè¯Açš„AIå›å¤å®Œæˆ

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¼šè¯Aå®Œæˆåï¼Œä¾§è¾¹æ ä¼šè¯Aæ ‡é¢˜åå‡ºç°çº¢è‰²å°åœ†ç‚¹ â—
- âœ… çº¢ç‚¹æœ‰å‘¼å¸åŠ¨ç”»æ•ˆæœ
- âœ… åˆ‡æ¢åˆ°ä¼šè¯Aåï¼Œçº¢ç‚¹ç«‹å³æ¶ˆå¤±
- âœ… æŸ¥çœ‹å®Œæ•´çš„AIå›å¤å†…å®¹

#### æµ‹è¯•åœºæ™¯3ï¼šå¤šä¸ªä¼šè¯å¹¶è¡Œ

**æ­¥éª¤**ï¼š
1. åˆ›å»º3ä¸ªä¼šè¯ï¼šAã€Bã€C
2. åœ¨ä¼šè¯Aå‘é€ä»»åŠ¡
3. åˆ‡æ¢åˆ°ä¼šè¯Bå‘é€ä»»åŠ¡
4. åˆ‡æ¢åˆ°ä¼šè¯Cå‘é€ä»»åŠ¡
5. è§‚å¯Ÿä¾§è¾¹æ 

**é¢„æœŸç»“æœ**ï¼š
- âœ… 3ä¸ªä¼šè¯åŒæ—¶å¤„ç†ä»»åŠ¡
- âœ… å®Œæˆçš„ä¼šè¯æ˜¾ç¤ºçº¢ç‚¹
- âœ… å¯ä»¥åœ¨ä¸åŒä¼šè¯é—´è‡ªç”±åˆ‡æ¢
- âœ… æ¯ä¸ªä¼šè¯çš„æ¶ˆæ¯ç‹¬ç«‹æ˜¾ç¤º

### æ€§èƒ½æµ‹è¯•

#### å†…å­˜å ç”¨æµ‹è¯•

**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯å¤šä¸ªAgentå®ä¾‹ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

**æ­¥éª¤**ï¼š
1. æ‰“å¼€åº”ç”¨ï¼Œè®°å½•åˆå§‹å†…å­˜å ç”¨
2. åˆ›å»º10ä¸ªä¼šè¯ï¼Œæ¯ä¸ªä¼šè¯å‘é€ä¸€æ¡æ¶ˆæ¯
3. ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯å®Œæˆ
4. è®°å½•æœ€ç»ˆå†…å­˜å ç”¨
5. åˆ é™¤æ‰€æœ‰ä¼šè¯
6. ç­‰å¾…5åˆ†é’Ÿåå†æ¬¡è®°å½•å†…å­˜

**é¢„æœŸç»“æœ**ï¼š
- âœ… å†…å­˜å¢é•¿åœ¨åˆç†èŒƒå›´å†…ï¼ˆ< 500MBï¼‰
- âœ… åˆ é™¤ä¼šè¯åå†…å­˜æ­£ç¡®é‡Šæ”¾
- âœ… æ²¡æœ‰å†…å­˜æ³„æ¼è¿¹è±¡

#### å¹¶å‘æ€§èƒ½æµ‹è¯•

**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯å¹¶è¡Œå¤„ç†çš„æ€§èƒ½ä¼˜åŠ¿

**æ­¥éª¤**ï¼š
1. ä¸²è¡Œå¤„ç†ï¼šå‘é€5ä¸ªä»»åŠ¡ï¼Œè®°å½•æ€»è€—æ—¶
2. å¹¶è¡Œå¤„ç†ï¼šåœ¨5ä¸ªä¼šè¯åŒæ—¶å‘é€5ä¸ªä»»åŠ¡ï¼Œè®°å½•æ€»è€—æ—¶

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¹¶è¡Œå¤„ç†æ€»è€—æ—¶ < ä¸²è¡Œå¤„ç†æ€»è€—æ—¶
- âœ… æ€§èƒ½æå‡ä¸ä»»åŠ¡æ•°é‡æˆæ­£æ¯”

### è¾¹ç•Œæµ‹è¯•

#### è¾¹ç•Œåœºæ™¯1ï¼šå¿«é€Ÿåˆ‡æ¢ä¼šè¯

**æ­¥éª¤**ï¼š
1. åœ¨ä¼šè¯Aå‘é€æ¶ˆæ¯
2. ç«‹å³åˆ‡æ¢åˆ°ä¼šè¯B
3. ç«‹å³åˆ‡æ¢åˆ°ä¼šè¯C
4. å¿«é€Ÿé‡å¤åˆ‡æ¢10æ¬¡

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ¶ˆæ¯æ­£ç¡®å‘é€åˆ°ä¼šè¯A
- âœ… æ²¡æœ‰æ¶ˆæ¯å‘é€åˆ°é”™è¯¯çš„ä¼šè¯
- âœ… ä¼šè¯Cæ˜¾ç¤ºçº¢ç‚¹ï¼ˆå¦‚æœAå®Œæˆï¼‰

#### è¾¹ç•Œåœºæ™¯2ï¼šç©ºç™½ä¼šè¯

**æ­¥éª¤**ï¼š
1. åˆ›å»ºç©ºç™½ä¼šè¯Aï¼ˆä¸å‘é€æ¶ˆæ¯ï¼‰
2. åˆ‡æ¢åˆ°ä¼šè¯B
3. åœ¨ä¼šè¯Bå‘é€æ¶ˆæ¯
4. è§‚å¯Ÿä¼šè¯A

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç©ºç™½ä¼šè¯Aä¸æ˜¾ç¤ºçº¢ç‚¹
- âœ… ç©ºç™½ä¼šè¯Aåˆ é™¤æ— éœ€ç¡®è®¤

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®ç»“æ„ä¼˜åŒ–

**ä½¿ç”¨Setæ›¿ä»£Array**ï¼š
```javascript
// âŒ ä½æ•ˆï¼šArray
const unreadConversations = [];  // O(n) æŸ¥æ‰¾
unreadConversations.includes(id);

// âœ… é«˜æ•ˆï¼šSet
const unreadConversations = new Set();  // O(1) æŸ¥æ‰¾
unreadConversations.has(id);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
- æŸ¥æ‰¾1000ä¸ªä¼šè¯ï¼š
  - Array: å¹³å‡500æ¬¡æ¯”è¾ƒ
  - Set: 1æ¬¡å“ˆå¸ŒæŸ¥æ‰¾

### 2. Agentå®ä¾‹å¤ç”¨

**æ‡’åŠ è½½ç­–ç•¥**ï¼š
```javascript
// åªåœ¨é¦–æ¬¡å‘é€æ¶ˆæ¯æ—¶åˆ›å»ºAgent
if (!targetAgent) {
  targetAgent = await agent.createAgent(...);
  conversationAgents.set(conversationId, targetAgent);
}
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘åˆå§‹åŒ–å¼€é”€
- æŒ‰éœ€åˆ›å»ºèµ„æº
- é¿å…æµªè´¹

### 3. äº‹ä»¶ç›‘å¬å™¨æ¸…ç†

**æ­£ç¡®ä½¿ç”¨useEffect**ï¼š
```javascript
useEffect(() => {
  const handler = (data) => {...};

  window.electronAPI.onMessageCompleted(handler);

  // âœ… æ¸…ç†å‡½æ•°ï¼šé¿å…å†…å­˜æ³„æ¼
  return () => {
    window.electronAPI.removeMessageCompletedListener();
  };
}, [currentChatId]);
```

**é‡è¦æ€§**ï¼š
- é˜²æ­¢äº‹ä»¶ç›‘å¬å™¨ç´¯ç§¯
- é¿å…å†…å­˜æ³„æ¼
- ç¡®ä¿ç»„ä»¶å¸è½½æ—¶æ­£ç¡®æ¸…ç†

### 4. æ¸²æŸ“ä¼˜åŒ–

**æ¡ä»¶æ¸²æŸ“ä¼˜åŒ–**ï¼š
```javascript
// âœ… åªåœ¨å¿…è¦æ—¶æ¸²æŸ“çº¢ç‚¹
{unreadConversations?.has(conv.id) && (
  <span className="unread-badge">â—</span>
)}
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘DOMèŠ‚ç‚¹
- é™ä½æ¸²æŸ“å¼€é”€
- æå‡æ€§èƒ½

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå°çº¢ç‚¹æœ‰æ—¶ä¸æ˜¾ç¤ºï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ˜¯å¦å½“å‰æ­£åœ¨è¯¥ä¼šè¯ä¸­ï¼Ÿï¼ˆçº¢ç‚¹åªåœ¨éæ´»è·ƒä¼šè¯æ˜¾ç¤ºï¼‰
2. æ¶ˆæ¯æ˜¯å¦çœŸçš„å®Œæˆäº†ï¼Ÿï¼ˆæ£€æŸ¥åç«¯æ—¥å¿—ï¼‰
3. IPCäº‹ä»¶æ˜¯å¦æ­£ç¡®ç›‘å¬ï¼Ÿï¼ˆæ£€æŸ¥æ§åˆ¶å°ï¼‰

### Q2: å¤šä¸ªAgentå®ä¾‹ä¼šå¢åŠ å†…å­˜æ¶ˆè€—å—ï¼Ÿ

**A**: ä¼šæœ‰ä¸€å®šå¢åŠ ï¼Œä½†é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–ï¼š
1. æ‡’åŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»º
2. å®ä¾‹å¤ç”¨ï¼šåŒä¸€ä¼šè¯å…±äº«ä¸€ä¸ªAgent
3. åˆç†æ§åˆ¶ï¼šå»ºè®®ä¸è¶…è¿‡10ä¸ªå¹¶è¡Œä¼šè¯

### Q3: å¹¶è¡Œä»»åŠ¡ä¼šå½±å“APIé™æµå—ï¼Ÿ

**A**: ä¼šçš„ï¼Œéœ€è¦æ³¨æ„ï¼š
1. åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚å¯èƒ½è§¦å‘APIé™æµ
2. å»ºè®®æ§åˆ¶å¹¶å‘æ•°é‡ï¼ˆ< 5ä¸ªï¼‰
3. ä½¿ç”¨å®˜æ–¹API Keyå¯èƒ½æœ‰æ›´é«˜çš„é™æµé˜ˆå€¼

### Q4: å¦‚ä½•å®ç°å°çº¢ç‚¹æ•°å­—è§’æ ‡ï¼Ÿ

**A**: å¯ä»¥æ‰©å±•åŠŸèƒ½ï¼š
```javascript
// ç»Ÿè®¡æ¯ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯æ•°
const unreadCounts = {
  conversationId1: 2,
  conversationId2: 5,
};

// æ˜¾ç¤ºæ•°å­—è§’æ ‡
<span className="unread-badge">
  {unreadCounts[conv.id] || 0}
</span>
```

### Q5: å¦‚ä½•æ‰¹é‡åˆ é™¤Agentå®ä¾‹ï¼Ÿ

**A**: å¯ä»¥æ·»åŠ æ¸…ç†åŠŸèƒ½ï¼š
```javascript
function clearInactiveAgents(activeConversationIds) {
  for (const [convId, agent] of conversationAgents) {
    if (!activeConversationIds.includes(convId)) {
      // æ¸…ç†Agentèµ„æº
      conversationAgents.delete(convId);
    }
  }
}
```

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| v2.10.1 | 2026-01-08 | åˆå§‹ç‰ˆæœ¬ï¼šå¹¶è¡Œä»»åŠ¡æ‰§è¡Œ + å°çº¢ç‚¹æç¤º |
| v2.10.2 | TBD | åç»­ä¼˜åŒ– |

---

## å‚è€ƒèµ„æ–™

- [Electron IPCæ–‡æ¡£](https://www.electronjs.org/docs/latest/tutorial/ipc)
- [Claude Agent SDKæ–‡æ¡£](https://docs.anthropic.com/claude-agent-sdk)
- [React Hooksæœ€ä½³å®è·µ](https://react.dev/reference/react)

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£éšä»£ç æ›´æ–°è‡ªåŠ¨ç»´æŠ¤
**åé¦ˆæ¸ é“**: å¦‚æœ‰é—®é¢˜è¯·åœ¨é¡¹ç›®GitHubæå‡ºIssue
