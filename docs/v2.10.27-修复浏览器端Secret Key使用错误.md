# 官方API Key容错机制 (v2.10.26)

> **适用版本**: v2.10.26+
> **功能类型**: 容错机制
> **更新时间**: 2026-01-09

---

## 📋 功能概述

官方API Key容错机制确保游客模式下，即使本地数据库中的API Key丢失或未初始化，系统也能自动从Supabase云端重新获取并恢复服务。

### 核心价值

- 🛡️ **自动容错**: 无需手动干预，系统自动恢复服务
- ⚡ **性能优化**: 三级缓存机制，减少重复查询
- 🔄 **自动同步**: 与Supabase云端配置保持一致
- 📊 **监控友好**: 详细的日志输出，便于调试

---

## 🎯 应用场景

### 场景1: 数据库文件损坏或丢失

**问题**: 用户数据库文件损坏，导致 `official_api_key` 丢失

**解决流程**:
```
1. 游客模式启动
2. 从数据库读取 official_api_key → 返回 NULL
3. 触发容错机制 → 从 Supabase 获取
4. 写入数据库
5. 更新缓存
6. 游客模式正常工作 ✅
```

### 场景2: 版本升级数据清空

**问题**: 版本升级时清空所有数据（包括数据库）

**解决流程**:
```
1. v2.10.25 → v2.10.26 升级
2. 数据库被清空（版本升级逻辑）
3. 下次启动时检测到 official_api_key 为空
4. 自动从 Supabase 重新获取配置
5. 写入数据库，恢复正常 ✅
```

### 场景3: 开发环境快速恢复

**问题**: 开发时清空数据库测试功能

**解决流程**:
```
1. 开发者删除数据库文件测试功能
2. 重启应用
3. 系统自动从 Supabase 恢复配置
4. 无需手动配置，继续开发 ✅
```

---

## 🔧 技术实现

### 代码位置

**文件**: `electron/official-config.js`

### 实现细节

```javascript
// v2.10.26 - 容错机制：防止重复从 Supabase 获取
let isFetchingFromSupabase = false;
let cachedApiKey = null;

module.exports = {
  // ✨ v2.10.26 容错机制：如果数据库中没有 API Key，自动从 Supabase 重新获取
  get apiKey() {
    // 1. 先尝试从缓存获取
    if (cachedApiKey) {
      return cachedApiKey;
    }

    // 2. 从数据库读取
    const key = db.getOfficialApiKey();

    if (key) {
      cachedApiKey = key;
      return key;
    }

    // 3. 如果数据库中没有，且没有正在获取，启动异步获取
    if (!key && !isFetchingFromSupabase) {
      console.warn('⚠️ 官方 API Key 未找到，尝试从 Supabase 重新获取...');
      isFetchingFromSupabase = true;

      // 异步从 Supabase 获取并写入数据库
      db.fetchOfficialConfigFromSupabase().then(config => {
        if (config && config.apiKey) {
          console.log('✅ 从 Supabase 重新获取官方配置成功');
          // 写入数据库
          db.setSystemConfig('official_api_key', config.apiKey, '官方智谱GLM API Key（游客模式使用）');
          db.setSystemConfig('official_provider', config.provider, '官方模型提供商');
          db.setSystemConfig('official_model', config.model, '官方默认模型');
          db.setSystemConfig('free_usage_limit', config.limit, '游客免费使用次数限制');
          db.setSystemConfig('official_config_initialized', 'true', '配置已初始化标记');
          console.log('✅ 官方配置已写入数据库');
          // 更新缓存
          cachedApiKey = config.apiKey;
        } else {
          console.error('❌ 从 Supabase 获取配置失败');
        }
        isFetchingFromSupabase = false;
      }).catch(error => {
        console.error('❌ 从 Supabase 获取配置出错:', error.message);
        isFetchingFromSupabase = false;
      });

      console.warn('⚠️ 正在从 Supabase 获取配置，请稍后重试...');
    }

    return null;
  },

  // 重置缓存（用于测试或强制刷新）
  resetCache() {
    cachedApiKey = null;
    isFetchingFromSupabase = false;
  },
```

---

## 🏗️ 架构设计

### 三级缓存机制

```
┌─────────────────┐
│  内存缓存       │ ← 第一级：最快
│  (cachedApiKey) │
└────────┬────────┘
         │ 未命中
         ↓
┌─────────────────┐
│  本地数据库     │ ← 第二级：较快
│ (system_config) │
└────────┬────────┘
         │ 未命中
         ↓
┌─────────────────┐
│  Supabase 云端  │ ← 第三级：最慢但最可靠
│ (system_configs)│
└─────────────────┘
```

### 数据流程

```
游客模式启动
  ↓
调用 officialConfig.apiKey
  ↓
检查缓存 → 有 → 返回 API Key ✅
  ↓ 无
检查数据库 → 有 → 缓存并返回 ✅
  ↓ 无
从 Supabase 获取 → 成功 → 写入数据库 → 缓存 → 返回 ✅
  ↓ 失败
返回 NULL ❌
```

---

## 📊 关键特性

### 1. 防止重复请求

**问题**: 如果多个请求同时发现 API Key 为空，可能会发起多次 Supabase 请求

**解决**:
```javascript
if (!key && !isFetchingFromSupabase) {
  // 只在第一次发起请求
  isFetchingFromSupabase = true;
  // ... 获取逻辑
}
```

### 2. 异步获取

**问题**: Supabase 请求是异步的，不能阻塞主流程

**解决**:
```javascript
// 立即返回 null（第一次）
db.fetchOfficialConfigFromSupabase().then(config => {
  // 异步获取并缓存
  cachedApiKey = config.apiKey;
});
```

**说明**:
- 第一次调用返回 `null`，可能导致 Agent 初始化失败
- 但下次调用（用户再次发送消息）时，已经缓存成功
- 实际使用中影响很小，因为只需要获取一次

### 3. 缓存重置

**用途**:
- 测试时强制刷新
- 手动触发重新获取
- 调试时验证流程

```javascript
officialConfig.resetCache(); // 清空缓存
```

---

## 🐛 调试与日志

### 正常流程日志

```
[启动] 初始化官方配置...
✅ 官方配置已初始化到数据库
[游客模式] 使用官方API Key: c2204ed032...
Agent 初始化成功 ✅
```

### 触发容错机制日志

```
⚠️ 官方 API Key 未找到，尝试从 Supabase 重新获取...
📡 正在连接 Supabase: https://cnszooaxwxatezodbbxq.s...
✅ Supabase 客户端创建成功
✅ 从 Supabase 重新获取官方配置成功
✅ 官方配置已写入数据库
```

### 失败情况日志

```
⚠️ 官方 API Key 未找到，尝试从 Supabase 重新获取...
❌ 从 Supabase 获取配置失败: [错误信息]
❌ 从 Supabase 获取配置出错: [错误信息]
```

---

## 🔍 常见问题

### Q1: 为什么第一次调用会返回 NULL？

**A**: 因为从 Supabase 获取是异步的：
- 第一次调用发现数据库为空
- 启动异步获取
- 立即返回 `null`
- 下次调用时已经缓存成功

**影响**: 极小，用户只需重新发送一次消息

### Q2: 如何检查容错机制是否工作？

**A**: 查看启动日志：
```
# 正常情况（数据库有值）
✅ 官方配置已存在，跳过初始化

# 触发容错（数据库为空）
⚠️ 官方 API Key 未找到，尝试从 Supabase 重新获取...
✅ 从 Supabase 重新获取官方配置成功
```

### Q3: 如何强制触发容错机制？

**A**: 删除数据库中的配置：
```bash
# 方法1: 删除整个数据库
rm ~/Library/Application\ Support/xiaobai-ai/xiaobai-ai.db

# 方法2: 使用测试脚本
node scripts/check-api-key.js
```

### Q4: 容错机制会影响性能吗？

**A**: 不会：
- 第一次调用后才建立缓存
- 后续调用直接从内存读取，极快
- Supabase 请求只执行一次

### Q5: 如果 Supabase 也无法获取怎么办？

**A**: 系统会返回错误：
```
❌ 从 Supabase 获取配置失败
Agent 初始化失败: 官方API Key未设置
```

**解决**: 检查以下配置：
1. Supabase `system_configs` 表中是否有 `official_api_key`
2. 环境变量是否正确配置
3. 网络连接是否正常

---

## 📝 相关代码文件

| 文件 | 说明 |
|-----|------|
| `electron/official-config.js` | 容错机制实现 |
| `electron/database.js` | `fetchOfficialConfigFromSupabase()` 函数 |
| `electron/main.js` | Agent 初始化逻辑 |
| `scripts/check-api-key.js` | 检查数据库 API Key 工具 |

---

## 🔗 相关文档

- [数据库设计 (system_config表)](./03-database-design.md#system_config表)
- [部署配置指南](./08-deployment-config.md#官方配置)
- [从Supabase获取API密钥配置指南](./从Supabase获取API密钥配置指南.md)
- [更新日志](./10-changelog.md#2026-01-09---v21026)

---

**功能作者**: Claude Code + 晓力
**最后更新**: 2026-01-09
**版本**: v2.10.26
