# 阿里云短信服务部署指南

本文档介绍如何为小白AI配置真实的阿里云短信验证码服务。

## 前置条件

1. 已有阿里云账号并开通短信服务
2. 已有 Supabase 项目
3. 已安装 Supabase CLI（用于部署 Edge Function）

## 第一步：获取阿里云 AccessKey

### 1.1 创建 AccessKey

1. 登录阿里云控制台：https://console.aliyun.com/
2. 点击右上角头像 → `AccessKey 管理`
3. 点击 `创建 AccessKey`
4. 记录 `AccessKey ID` 和 `AccessKey Secret`（只显示一次，请妥善保存）

**当前项目的 AccessKey：**
- `AccessKey ID`: `LTAI5tXXXXXXXXXXXXXX`
- `AccessKey Secret`: 需要从阿里云控制台获取

### 1.2 短信签名和模板

**已配置的信息：**
- **短信签名**: `原则科技`
- **模板CODE**: `SMS_223880024`
- **模板内容**: `您的验证码是${code}，5分钟内有效。`

## 第二步：部署 Supabase Edge Function

### 2.1 安装 Supabase CLI

```bash
# macOS
brew install supabase/tap/supabase

# 验证安装
supabase --version
```

### 2.2 登录 Supabase

```bash
# 关联项目
supabase link --project-ref your-project-ref

# 输入你的数据库密码（在 Supabase Dashboard → Settings → Database）
```

### 2.3 配置环境变量

在 Supabase Dashboard 中配置环境变量：

1. 打开 Supabase Dashboard: https://supabase.com/dashboard/project/your-project-ref
2. 进入 `Settings` → `Edge Functions`
3. 在 `Environment Variables` 部分添加以下变量：

```bash
ALIYUN_ACCESS_KEY_ID=LTAI5tXXXXXXXXXXXXXX
ALIYUN_ACCESS_KEY_SECRET=你的AccessKeySecret
```

### 2.4 部署 Edge Function

```bash
# 进入项目目录
cd /Users/shawn/Downloads/小白AI

# 部署 send-sms 函数
supabase functions deploy send-sms
```

部署成功后会显示：
```
Deployed Function send-sms
  URL: https://your-project.supabase.co/functions/v1/send-sms
```

## 第三步：测试短信发送

### 3.1 使用 curl 测试

```bash
curl -X POST 'https://your-project.supabase.co/functions/v1/send-sms' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_SERVICE_ROLE_KEY' \
  -d '{
    "phone": "13800138000",
    "code": "123456"
  }'
```

### 3.2 查看日志

在 Supabase Dashboard 中查看 Edge Function 日志：
1. 进入 `Edge Functions` → `send-sms`
2. 点击 `Logs` 标签
3. 查看函数执行日志

## 第四步：前端配置

前端代码已经自动配置好，无需修改。代码位置：
- `src/lib/cloudService.js` - 短信发送逻辑
- `src/lib/supabaseClient.js` - Supabase 客户端配置

## 常见问题

### Q1: Edge Function 部署失败

**解决方案：**
- 检查 Supabase CLI 是否已正确安装
- 确认已正确链接项目（`supabase link`）
- 查看错误日志，根据提示修复

### Q2: 短信发送失败

**解决方案：**
- 检查阿里云账户余额（短信服务需要充值）
- 确认 AccessKey 是否正确
- 检查手机号格式是否正确（1开头的11位数字）
- 确认短信签名和模板已通过审核

### Q3: 验证码验证失败

**解决方案：**
- 确认验证码未过期（5分钟有效期）
- 检查数据库中 `verification_codes` 表
- 查看前端控制台日志

### Q4: CORS 错误

**解决方案：**
- 在 Supabase Dashboard 中配置 CORS
- 设置 `Allowed origins` 为 `*` 或指定域名

## 成本估算

阿里云短信服务价格：
- 国内短信：¥0.045/条
- 假设每天 100 次登录请求：100 条/天 × ¥0.045 = ¥4.5/天
- 月成本：¥4.5 × 30 = ¥135/月

## 安全建议

1. **不要在前端代码中暴露 AccessKey Secret**
   - 使用 Edge Function 作为中间层
   - AccessKey 只存储在 Supabase 环境变量中

2. **限制验证码发送频率**
   - 同一手机号 1 分钟内只能发送 1 次
   - 同一手机号 1 天内最多发送 10 次

3. **定期更换 AccessKey**
   - 建议每 3-6 个月更换一次
   - 如果泄露，立即在阿里云控制台删除并重新创建

## 部署检查清单

- [ ] 已创建阿里云 AccessKey
- [ ] 已记录 AccessKey ID 和 Secret
- [ ] 短信签名和模板已通过审核
- [ ] 阿里云账户已充值
- [ ] Supabase CLI 已安装
- [ ] 已链接 Supabase 项目
- [ ] 环境变量已配置
- [ ] Edge Function 已部署
- [ ] 测试短信发送成功
- [ ] 前端登录流程测试通过

## 下一步

部署完成后，测试完整的登录流程：
1. 打开小白AI应用
2. 点击"登录"按钮
3. 输入手机号
4. 点击"发送验证码"
5. 查收手机短信
6. 输入验证码
7. 登录成功

---

**文档版本**: v1.0
**最后更新**: 2026-01-06
**维护者**: 晓力
